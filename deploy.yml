## Deploy Jobs ##
variables:
  ENVIRONMENT_NAME: "dev"
  SERVER_URL: ""
  WEB_ROOT: "/opt/www/html"

### Generic deploy to specified server ###
.deploy_template:
  stage: deploy
  environment:
    name: $ENVIRONMENT_NAME
    url: $SERVER_URL
  script:
    - echo "Deploying to server at $SERVER_URL"
    - cd $WEB_ROOT
    - git fetch
    - git reset --hard
    - git stash
    - git pull

### Drupal install jobs ###
.drupal_dev:
  stage: deploy
  environment:
    name: $ENVIRONMENT_NAME
    url: $SERVER_URL
  script:
    - cd $WEB_ROOT
    - composer install #default assumes with dev requirements
    - vendor/drush/drush/drush cr #helps discover any new modules installed. Does not help if modules were deleted.
    - vendor/drush/drush/drush config-import -y
    - vendor/drush/drush/drush cr
    - vendor/drush/drush/drush updb
    - vendor/drush/drush/drush cr

.drupal_prod_composer:
  stage: deploy
  environment:
    name: $ENVIRONMENT_NAME
    url: $SERVER_URL
  after_script:
    - cd $WEB_ROOT
    - vendor/drush/drush/drush state:set system.maintenance_mode 1 --input-format=integer

.drupal_prod_config:
  stage: deploy
  environment:
    name: $ENVIRONMENT_NAME
    url: $SERVER_URL
  script:
    - cd $WEB_ROOT
    - vendor/drush/drush/drush state:set system.maintenance_mode 1 --input-format=integer
    - vendor/drush/drush/drush cr
    - vendor/drush/drush/drush config-import -y
    - vendor/drush/drush/drush cr
    - vendor/drush/drush/drush updb
    - vendor/drush/drush/drush state:set system.maintenance_mode 0 --input-format=integer
    - vendor/drush/drush/drush cr

.drupal_prod_cache:
  stage: deploy
  environment:
    name: Production 2
    url: prod2.demo.com
  tags:
    - prod2
  script:
    - cd /opt/www/html
    - vendor/drush/drush/drush cr